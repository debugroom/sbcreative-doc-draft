:lang: ja
:doctype: book
:toc: left
:toclevels: 3
:toc-title: 目次
:sectnums:
:sectnumlevels: 4
:sectlinks:
:imagesdir: ./images
:icons: font
:source-highlighter: coderay
:example-caption: Example
:table-caption: Table
:figure-caption: Figure
:docname: = 3-4.コンテナアプリケーション
:revnumber: 0.1
:revdate: 2020/5/5

= コンテナアプリケーション

== AWSにおけるコンテナアプリケーション

この章では、Dockerに代表されるコンテナを使ったWebプリケーションをAWS上に構築するときのシステムアーキテクチャや、構築時に利用頻度が高い
以下のようなAWSサービスに関する解説を行います。

|===
|サービス|用途|概要
|Amazon VPC(Virtual Private Cloud)|ネットワークアクセス制御|
AWS上にネットワークを構築し、アクセス制御を行うためのサービス
|Amazon ECS(Elastic Container Service)|コンテナオーケストレーション|
Dockerコンテナを簡単に実行、停止、管理できるスケーラブルで高速なコンテナ管理サービス
|ALB(Application Load Balancer)|負荷分散|
AWSで利用できるマネージドロードバランサー。ECSで構築されたアプリケーションの負荷分散を実行。
|AWS EFS(Elastic File System)|ネットワーク共有ストレージ|
VPC内のコンテナからアクセス可能なネットワーク共有ストレージ
|AWS S3(Simple Storage Service)|リージョン共有ストレージ|
クライアントを含むパブリックアクセス可能な共有ストレージ
|AWS ElastiCache|共有キャッシュ|
アプリケーションから利用されるキャッシュおよびセッションなどの共通ストレージ
|AWS RDS(Relational Database Service)|データベース|
厳密な一貫性をもって保存する必要があるデータベース
|Amazon DynamoDB|データベース|
スケーラビリティが必要なデータベース
|AWS ECR(Elastic Container Registry)|コンテナレジストリ|
Dockerコンテナイメージを保存・管理するAWSマネージドレジストリサービス
|Amazon EKS(Elastic Kubernetes Service)|コンテナオーケストレーション|
コンテナオーケストレーションプラットフォームKubernetesをAWS上で実行するマネージドサービス
|AWS AppMesh|負荷分散・通信制御|
EKS、ECSで構築されたアプリケーション間通信を負荷分散・監視するサービスメッシュ。オープンソースソフトウェアのEnvoyのマネージドサービス。
|Amazon Cassandra Service|データベース|
スケーラビリティが必要なデータベース
|===

これらのサービスを用いるコンテナアプリケーションでは、しばしば、以下のようなシステムアーキテクチャで構築されます。

.ECSを使ったコンテナアプリケーションのシステムアーキテクチャ
image::container-architecture-1.png[]

.EKSを使ったコンテナアプリケーションのシステムアーキテクチャ
image::container-architecture-2.png[]

== 構成するAWSサービスの特徴、メリット・デメリット

何故、AWS上でこのようなシステム構成をとるのでしょうか？
従来、Webアプリケーションは性能、可用性、セキュリティといった非機能要求に基づき、Webサーバ、アプリケーションサーバ、データベースといった３層構造をとり、
インターネットからの直接的なAPサーバへのアクセスを回避するDMZ(非武装地帯)やプライベートセグメント
(内部ネットワークやDMZを経由したリクエストのみを許容するセグメント)にネットワークを分離して
各サーバごとに複数台で冗長化構成を組んで構築していました。

.従来のWebアプリケーションシステム構成
image::web-3layer.png[]

Webアプリケーションはそのシステムの非機能要件に基づき、以下のような可用性・性能向上、セキュリティ対策などを講じます。

* ロードバランサーやWeb、APサーバを冗長化し、単一障害点を除去・負荷分散
* APサーバやデータベースが配置されるプライベートセグメントへのアクセス制御

しかし、このような環境の構築は思った以上に時間や負荷がかかる大変な作業です。非機能要件に基づき、性能要求に見合ったハードウェア・ソフトウェアの選定や、
冗長化に必要な台数の見積もり、サーバの購入・搬入後の環境設定等、作業は多岐に渡ります。
このような作業工程・時間的なコストは、AWSなどのクラウドや、それと合わせて提供されるマネージドサービスを活用することにより大幅に軽減することが可能になります。
それでは、上記の表で記載した各AWSサービスを解説しながら、どのようなメリットが持たされるのか整理してみましょう。

=== VPC

==== VPCの概要

VPC(Virtual Private Network)では、仮想プライベートネットワークを構築できます。ここで仮想とは、
実際のサーバ機器がない状態でネットワーク構築を行い、クラウド上にAWSがプールしてあるサーバである「EC2」や
データベース「RDS」などのAWSリソースを、構築したその仮想プライベートネットワーク上に配置することが可能になります。
この仕組みにより、オンデマンドで、ネットワークおよびサーバを含むシステム環境の構築が随時かつ迅速に行うことができます。

.VPCと物理ネットワークの違い
image::vpc.png[]

VPCは、AWSのリージョン単位に作成でき、XXX.XXX.XXX.XXX/16〜28であるCIDR表記に沿って構築することが可能です。
構築したVPCでは、セグメントに相当する複数のサブネットを定義でき、複数のVPC間の通信はもちろんのこと、
オンプレミスとの接続サービスであるDirectConnectやVPNを通じて、オンプレミス環境にあるサーバとも通信できます。

[NOTE]
====
* VPCは１リージョン内に構築されます。リージョンをまたいで別のVPCと通信したい場合は、インターリージョンVPCを使うと、一部のリージョン同士でVPC間の相互接続が可能です。
* VPCは複数のアベイラビリティゾーンを跨ぐことはできますが、サブネットは各アベイラビリティゾーン毎に作成する必要があります
* VPC内のアドレスはCIDRが/16か/28の間で使用できますが、以下の通り、各サブネットの最初の４アドレス、最後の1アドレスは予約されていて使用不可のため注意が必要です。

  ** XXX.XXX.XXX.0 (ネットワークアドレス用)
  ** XXX.XXX.XXX.1 (VPCルータ)
  ** XXX.XXX.XXX.2 (Amazon Provided DNS)
  ** XXX.XXX.XXX.3 (予備)
  ** XXX.XXX.XXX.255 (ブロードキャストはサポートしていないが予約)

* CIDRは一度作成すると変更することができませんでしたが、2017年10月よりVPCに割り当てるCIDRが拡張可能となりました。

====

==== VPCの外部通信

VPC内のリソースが外部通信する際は、ネットワークゲートウェイをVPCに設置しますが、接続は以下３種類があります。

* インターネットゲートウェイ
* 仮想プライベートゲートウェイ
* VPCピア接続

.VPCの外部接続
image::outbound.png[]

===== インターネットゲートウェイ

インターネットゲートウェイは文字通りインターネットとの通信ですが、通信元のAWSリソースが
パブリックIPアドレスを持っている必要があります。 パブリックアドレスは動的に割り当てられるものと、
固定的に割り当てられるものがあり、後者を「Elastic IP Address」と呼びます。
インターネットゲートウェイは定義としては1つの機器のように扱われますが、内部的に冗長化されており、
通信が増加した際には自動的にスケーリングされます。またシステムの保守作業で最新のミドルウェアや
セキュリティパッチを入手する際も インターネットゲートウェイの設置が必須になるので、閉塞したネットワークの際は考慮が必要です。

===== 仮想プライベートゲートウェイ(VPN-GW)

仮想プライベートゲートウェイはVPCとオンプレミス環境をVPN接続するためのネットワークゲートウェイです。
インターネットゲートウェイ同様、冗長化構成をとり、動的ルーティングと静的ルーティング両方をサポートします。
動的ルーティングではBGPピア接続を利用して、オンプレミスと接続します。
ユーザ側のリモートエンドポイントで BGPアドバタイズにより、ルーティングの優先順位、ポリシーなど設定が可能です。
静的ルーティングにおいて、オンプレミス環境では、VPN通信が行えるルーターと、接続を許可するIPアドレスの設定のために、
固定的なパブリックIPアドレスが必要になります。

===== VPCピア接続

VPCピア接続はそれぞれ独立した仮想プライベートネットワークである2つのVPCを接続し、
プライベートアドレスで相互に通信します。こちらもインターネットゲートウェイ、仮想プライベートゲートウェイと同様、
冗長化構成をとります。自分が所有しているVPCだけではなく、同じリージョンの別アカウントのVPCとも接続が可能です。
ただし、接続できるのはVPCの範囲内に限られ、接続先のVPCがさらにまたVPN接続されているネットワークには接続できません。

==== VPCのアクセス制御

VPCにおける通信のアクセス制御方法として以下のようなものがあります。

* ルートテーブル
* セキュリティグループ
* ネットワークACL

===== ルートテーブル

VPC内の通信では、ルートテーブルというアクセスのための下記の図のようなルーティングルールセットを定義する必要があります。

.ルートテーブルの作成・設定例
image::route-table.png[]

VPCを作成すると通常同時にメインルートテーブルが作成されますが、追加でカスタムルートテーブルを作成し、
サブネット間のアクセス・通信制御を行います。VPC内の各サブネットはルートテーブルに関連づけられる必要があり、
サブネットが特定のルートテーブルに明示的に関連付けていない場合、サブネットは自動的にメインルートテーブルに
暗黙的に関連づけられます。１つのサブネットに同時に複数のルートテーブルを関連づけることはできませんが、
複数のサブネットを１つのルートテーブルに関連づけることはできます。

===== セキュリティグループ

セキュリティグループは一言で言えば、Linuxにおけるファイアウォール機能であるIPTablesとほぼ同等の機能です。
アクセス許可するソースやプロトコル・ポートのルール定義を作成し、EC2やRDSなどのAWSリソースに関連付けることで、ファイアウォールとして動作します。
受信と送信の両方をリソースレベルで制御でき、リソースをグループ化し、共通のセキュリティグループを関連付けることもできます。
一般的なファイアウォール同様、ステートフルに動作し、発生した通信に対する応答通信は自動的に許可されます。

.セキュリティグループの作成・設定例
image::security-group.png[]

===== ネットワークACL

ネットワークACLはサブネットに関連付けられ、受信と送信の両方をサブネットレベルで制御できます。
関連付けられたサブネット全てに適用されるのでセキュリティグループより広範囲な制御設定が可能ですが、
セキュリティグループとは異なりステートレスに動作するため、応答通信にも許可の設定が必要です。

.ネットワークACLの作成・設定例
image::network-acl.png[]

[NOTE]
=====
* 戻り宛先のIPとポートが必要：ポートは特定できないので事実上任意設定)となることに注意が必要です。
* セキュリティグループは許可設定しかできないので、特定のクライアントのアクセスをブロックしたいときはネットワークACLを使います。
=====
